/*
 WinChan is Copyright (c) 2012 Lloyd Hilaiel
 https://github.com/lloyd/winchan */
'use strict';var WinChan=function(){function d(h,b,a){h.attachEvent?h.attachEvent("on"+b,a):h.addEventListener&&h.addEventListener(b,a,!1)}function e(h,b,a){h.detachEvent?h.detachEvent("on"+b,a):h.removeEventListener&&h.removeEventListener(b,a,!1)}function c(){try{var b=navigator.userAgent;return-1!=b.indexOf("Fennec/")||-1!=b.indexOf("Firefox/")&&-1!=b.indexOf("Android")}catch(a){}return!1}function f(b){/^https?:\/\//.test(b)||(b=window.location.href);var a=/^(https?:\/\/[\-_a-zA-Z\.0-9:]+)/.exec(b);
return a?a[1]:b}function a(){for(var b=window.location,a=window.opener.frames,b=b.protocol+"//"+b.host,c=a.length-1;0<=c;c--)try{if(0===a[c].location.href.indexOf(b)&&a[c].name===g)return a[c]}catch(d){}}var g="__winchan_relay_frame",b="die",n=function(){var b=-1;"Microsoft Internet Explorer"===navigator.appName&&null!=/MSIE ([0-9]{1,}[.0-9]{0,})/.exec(navigator.userAgent)&&(b=parseFloat(RegExp.$1));return 8<=b}();return window.JSON&&window.JSON.stringify&&window.JSON.parse&&window.postMessage?{open:function(a,
k){function l(){m&&document.body.removeChild(m);m=void 0;if(r)try{r.close()}catch(a){p.postMessage(b,t)}r=p=void 0}function s(b){try{var a=JSON.parse(b.data);"ready"===a.a?p.postMessage(u,t):"error"===a.a?k&&(k(a.d),k=null):"response"===a.a&&(e(window,"message",s),e(window,"unload",l),l(),k&&(k(null,a.d),k=null))}catch(c){}}if(!k)throw"missing required callback argument";var q;a.url||(q="missing required 'url' parameter");a.relay_url||(q="missing required 'relay_url' parameter");q&&setTimeout(function(){k(q)},
0);a.window_name||(a.window_name=null);if(!a.window_features||c())a.window_features=void 0;var m,t=f(a.url);if(t!==f(a.relay_url))return setTimeout(function(){k("invalid arguments: origin of url and relay_url must match")},0);var p;n&&(m=document.createElement("iframe"),m.setAttribute("src",a.relay_url),m.style.display="none",m.setAttribute("name",g),document.body.appendChild(m),p=m.contentWindow);var r=window.open(a.url,a.window_name,a.window_features);p||(p=r);var u=JSON.stringify({a:"request",
d:a.params});d(window,"unload",l);d(window,"message",s);return{close:l,focus:function(){if(r)try{r.focus()}catch(a){}}}},onOpen:function(c){function g(a){a=JSON.stringify(a);n?m.doPost(a,q):m.postMessage(a,q)}function f(a){var b;try{b=JSON.parse(a.data)}catch(d){}b&&"request"===b.a&&(e(window,"message",f),q=a.origin,c&&setTimeout(function(){c(q,b.d,function(a){c=void 0;g({a:"response",d:a})})},0))}function s(a){if(a.data===b)try{window.close()}catch(c){}}var q="*",m=n?a():window.opener;if(!m)throw"can't find relay frame";
d(n?m:window,"message",f);d(n?m:window,"message",s);try{g({a:"ready"})}catch(t){d(m,"load",function(a){g({a:"ready"})})}var p=function(){try{e(n?m:window,"message",s)}catch(a){}c&&g({a:"error",d:"client closed window"});c=void 0;try{window.close()}catch(b){}};d(window,"unload",p);return{detach:function(){e(window,"unload",p)}}}}:{open:function(a,b,c,g){setTimeout(function(){g("unsupported browser")},0)},onOpen:function(a){setTimeout(function(){a("unsupported browser")},0)}}}();/*
 Copyright (c) 2013 David Benjamin and Alan Huang
 Use of this source code is governed by an MIT-style license that
 can be found at
 https://github.com/davidben/webathena
*/
var Err=function(d,e,c){this.ctx=d;this.code=e;this.msg=c};Err.Context={};Err.Context.KEY=2;Err.Context.NET=3;Err.Context.UNK=15;
var Crypto={randomNonce:function(){var d=sjcl.random.randomWords(1)[0];0>d&&(d+=2147483648);return d},retryForEntropy:function(d){var e=Q.defer(),c=function(){sjcl.random.removeEventListener("seeded",c);try{e.resolve(d())}catch(f){f instanceof sjcl.exception.notReady?sjcl.random.addEventListener("seeded",c):e.reject(f)}};c();return e.promise}},KDC=function(){function d(a){for(var c=0;c<a.length;c++)if(a[c].padataType==krb.PA_ETYPE_INFO2)return a=krb.ETYPE_INFO2.decodeDER(a[c].padataValue),void 0!==
a.salt&&(a.salt=arrayutils.fromUTF16(a.salt)),a;for(c=0;c<a.length;c++)if(a[c].padataType==krb.PA_ETYPE_INFO)return krb.ETYPE_INFO.decodeDER(a[c].padataValue);for(c=0;c<a.length;c++)if(a[c].padataType==krb.PA_PW_SALT)return[{salt:a[c].padataValue}];return[]}function e(a,c,b){c="salt"in a?a.salt:arrayutils.fromUTF16(c.realm+c.principalName.nameString.join(""));return krb.Key.fromPassword(a.etype,b,c,a.s2kparams)}var c={urlBase:"/kdc/v1/",Error:function(a,c){this.code=a;this.message=c}};c.Error.prototype.toString=
function(){return"KDC Error "+this.code+": "+this.message};c.NetworkError=function(a){this.message=a};c.NetworkError.prototype.toString=function(){return this.message};c.xhrRequest=function(a,d){var b=Q.defer(),e=new XMLHttpRequest;e.open("POST",c.urlBase+d);e.onreadystatechange=function(a){4==this.readyState&&(200==this.status?b.resolve(this.responseText):this.status?b.reject(new c.NetworkError("HTTP error "+this.status+": "+this.statusText)):b.reject(new c.NetworkError("Network error")))};e.setRequestHeader("X-WebKDC-Request",
"OK");a?(e.setRequestHeader("Content-Type","text/plain"),e.send(arrayutils.toBase64(a))):e.send();return b.promise};c.kdcProxyRequest=function(a,d,b){return c.xhrRequest(a,d).then(function(a){a=JSON.parse(a);switch(a.status){case "ERROR":throw new c.NetworkError(a.msg);case "TIMEOUT":throw new c.NetworkError("KDC connection timed out");case "OK":return a=arrayutils.fromBase64(a.reply),b.decodeDER(a)[1]}})};c.asReq=function(a,d){return Crypto.retryForEntropy(function(){var b={};b.pvno=krb.pvno;b.msgType=
krb.KRB_MT_AS_REQ;void 0!==d&&(b.padata=d);b.reqBody={};b.reqBody.kdcOptions=krb.KDCOptions.make(krb.KDCOptions.forwardable,krb.KDCOptions.proxiable,krb.KDCOptions.renewable_ok);if(a.realm!=krb.realm)throw"Cross-realm not supported!";b.reqBody.principalName=a.principalName;b.reqBody.realm=krb.realm;b.reqBody.sname={};b.reqBody.sname.nameType=krb.KRB_NT_SRV_INST;b.reqBody.sname.nameString=["krbtgt",krb.realm];b.reqBody.till=new Date(0);b.reqBody.nonce=Crypto.randomNonce();b.reqBody.etype=krb.supportedEnctypes;
return c.kdcProxyRequest(krb.AS_REQ.encodeDER(b),"AS_REQ",krb.AS_REP_OR_ERROR).then(function(a){return{asReq:b,asRep:a}})})};var f={};f[krb.PA_ENC_TIMESTAMP]=function(a,c,b,f,h,k){a=d(b);c=null;for(b=0;b<a.length;b++)if(a[b].etype in kcrypto.encProfiles){c=a[b];break}if(null===c)throw new Err(Err.Context.KEY,3,"No supported enctypes");var l=e(c,h,k);return Crypto.retryForEntropy(function(){var a={};a.patimestamp=new Date;a.pausec=1E3*a.patimestamp.getUTCMilliseconds();a.patimestamp.setUTCMilliseconds(0);
a=l.encryptAs(krb.ENC_TS_ENC,krb.KU_AS_REQ_PA_ENC_TIMESTAMP,a);return{padataType:krb.PA_ENC_TIMESTAMP,padataValue:krb.ENC_TIMESTAMP.encodeDER(a)}})};c.getTGTSession=function(a,g){return c.asReq(a).then(function(b){var d=b.asReq,e=b.asRep;if(e.msgType==krb.KRB_MT_ERROR&&e.errorCode==krb.KDC_ERR_PREAUTH_REQUIRED)for(var k=krb.METHOD_DATA.decodeDER(e.eData),l=0;l<k.length;l++)if(k[l].padataType in f)return f[k[l].padataType](d,e,k,k[l],a,g).then(function(b){return c.asReq(a,[b])});return b}).then(function(b){var f=
b.asReq;b=b.asRep;if(b.msgType==krb.KRB_MT_ERROR)throw new c.Error(b.errorCode,b.eText);var h={};if(b.padata){var k=d(b.padata);if(k){if(1!=k.length)throw"Bad pre-auth hint";h=k[0];if("etype"in h&&h.etype!=b.encPart.etype)throw"Bad pre-auth hint";}}h.etype=b.encPart.etype;h=e(h,a,g);return c.sessionFromKDCRep(h,krb.KU_AS_REQ_ENC_PART,f,b)})};c.sessionFromKDCRep=function(a,c,b,d){if(b.reqBody.principalName){if(d.crealm!=b.reqBody.realm)throw new Err(Err.Context.KEY,16,"crealm does not match");if(!krb.principalNamesEqual(b.reqBody.principalName,
d.cname))throw new Err(Err.Context.KEY,17,"cname does not match");}a=a.decryptAs(krb.EncASorTGSRepPart,c,d.encPart)[1];if(b.reqBody.nonce!=a.nonce)throw new Err(Err.Context.KEY,18,"nonce does not match");if(!krb.principalNamesEqual(b.reqBody.sname,a.sname))throw new Err(Err.Context.KEY,19,"sname does not match");return new krb.Session(d,a)};c.getServiceSession=function(a,d){return Crypto.retryForEntropy(function(){var b={};b.pvno=krb.pvno;b.msgType=krb.KRB_MT_TGS_REQ;b.reqBody={};b.reqBody.kdcOptions=
krb.KDCOptions.make(krb.KDCOptions.forwardable);b.reqBody.sname=d.principalName;b.reqBody.realm=d.realm;b.reqBody.till=new Date(0);b.reqBody.nonce=Crypto.randomNonce();b.reqBody.etype=krb.supportedEnctypes;var e=a.key.checksum(krb.KU_TGS_REQ_PA_TGS_REQ_CKSUM,krb.KDC_REQ_BODY.encodeDER(b.reqBody)),e=a.makeAPReq(krb.KU_TGS_REQ_PA_TGS_REQ,e).apReq;b.padata=[{padataType:krb.PA_TGS_REQ,padataValue:krb.AP_REQ.encodeDER(e)}];return c.kdcProxyRequest(krb.TGS_REQ.encodeDER(b),"TGS_REQ",krb.TGS_REP_OR_ERROR).then(function(d){if(d.msgType==
krb.KRB_MT_ERROR)throw new c.Error(d.errorCode,d.eText);return c.sessionFromKDCRep(a.key,krb.KU_TGS_REQ_ENC_PART,b,d)})})};return c}();var SERVICES={};SERVICES["krbtgt/"+krb.realm+"@"+krb.realm]={dangerous:!0,desc:"Full access to your Athena account"};SERVICES["moira/moira7.mit.edu@"+krb.realm]={dangerous:!0,desc:"View and modify your mailing lists and groups"};SERVICES["afs/athena.mit.edu@"+krb.realm]={dangerous:!0,desc:"Full access to all your files on Athena"};SERVICES["zephyr/zephyr@"+krb.realm]={desc:"Send and receive zephyr notices as you"};
function makeServiceNode(d){var e=d.toString(),c=document.createElement("li"),f=document.createElement("abbr");c.appendChild(f);f.title=e;if(e in SERVICES)d=SERVICES[e],d.dangerous&&(c.className="dangerous"),$(f).text(d.desc);else{var a=document.createElement("code");a.className="identifier";2===d.principalName.nameString.length&&"host"===d.principalName.nameString[0]?$(a).text(d.principalName.nameString[1]):$(a).text(e);f.appendChild(document.createTextNode("Access "));f.appendChild(a);f.appendChild(document.createTextNode(" on your behalf"))}return c}
function registerTicketAPI(){WinChan.onOpen(function(d,e,c){function f(a,b){if("string"!==typeof b)throw new TypeError;if(!(a instanceof Array))throw new TypeError;a.forEach(function(a){if("string"!==typeof a)throw new TypeError;});return new krb.Principal({nameType:krb.KRB_NT_UNKNOWN,nameString:a},b)}function a(){c({status:"DENIED",code:"NOT_ALLOWED"})}var g=[],b=!0;try{if(e.services){if(!(e.services instanceof Array))throw TypeError();g=e.services.map(function(a){return f(a.principal,a.realm)});
if(0==g.length)throw Error();}else g=[f(e.principal,e.realm)],b=!1}catch(n){throw c({status:"ERROR",code:"BAD_REQUEST"}),n;}"https://"!=d.substring(0,8)&&"http://localhost:"!=d.substring(0,17)?a():getTGTSession().then(function(e){var f=e[0];e=e[1];var l=$("#request-ticket-template").children().clone();l.appendTo(document.body);e&&l.fadeIn();l.find(".client-principal").text(f.client.toString());l.find(".foreign-origin").text(d);var n=l.find(".permission-list");g.forEach(function(a){n.append(makeServiceNode(a))});
l.find(".service-principal").text(g.map(function(a){return a.toString()}).join(", "));l.find(".request-ticket-deny").click(a);l.find(".request-ticket-allow").click(function(d){localStorage.getItem("tgtSession")?f.isExpired()?(log("Ticket expired"),a()):Q.all(g.map(function(a){return KDC.getServiceSession(f,a)})).then(function(a){b?c({status:"OK",sessions:a.map(function(a){return a.toDict()})}):c({status:"OK",session:a[0].toDict()})},function(b){log(b);a()}).done():(log("No ticket"),a())})}).done()})}
;sjcl.random.startCollectors();KDC.xhrRequest(null,"urandom").then(function(d){d=arrayutils.fromBase64(d);d=new Uint32Array(d.buffer,d.byteOffset,d.byteLength/4);for(var e=[],c=0;c<d.length;c++)e.push(d[c]);sjcl.random.addEntropy(e,32*e.length,"server")}).done();
function showLoginPrompt(){var d=Q.defer(),e=$("#login-template").children().clone();e.appendTo(document.body);e.find(".username").focus();e.submit(function(c){c.preventDefault();$("#alert").slideUp(100);var f=$(this).find(".username")[0];c=$(this).find(".password")[0];var a=f.value,f=c.value,g=!1;a?$(this).find(".username + .error").fadeOut():($(this).find(".username + .error").fadeIn(),g=!0);f?$(this).find(".password + .error").fadeOut():($(this).find(".password + .error").fadeIn(),g=!0);if(!g){c.value=
"";var b=$(this).find(".submit"),n=b.text();b.attr("disabled","disabled").text(".");var h=setInterval(function(){b.text((b.text()+".").replace(".....","."))},500),k=function(){clearInterval(h);b.attr("disabled",null).text(n)};c=krb.Principal.fromString(a);KDC.getTGTSession(c,f).then(function(a){k();e.fadeOut(function(){$(this).remove()});d.resolve(a)},function(a){a=a instanceof kcrypto.DecryptionError?"Incorrect password!":a instanceof KDC.Error?a.code==krb.KDC_ERR_C_PRINCIPAL_UNKNOWN?"User does not exist!":
a.code==krb.KDC_ERR_PREAUTH_FAILED||a.code==krb.KRB_AP_ERR_BAD_INTEGRITY?"Incorrect password!":a.message:String(a);$("#alert-title").text("Error logging in:");$("#alert-text").text(a);$("#alert").slideDown(100);k()}).done()}});return d.promise}
function showRenewPrompt(d){var e=Q.defer(),c=$("#renew-template").children().clone();c.find(".client-principal").text(d.client.toString());c.find(".logout-link").click(function(d){d.preventDefault();c.remove();e.resolve(showLoginPrompt())});c.appendTo(document.body);c.find(".password").focus();c.submit(function(f){f.preventDefault();$("#alert").slideUp(100);f=$(this).find(".password")[0];var a=f.value;if(a){$(this).find(".password + .error").fadeOut();f.value="";var g=$(this).find(".submit"),b=g.text();
g.attr("disabled","disabled").text(".");var n=setInterval(function(){g.text((g.text()+".").replace(".....","."))},500),h=function(){clearInterval(n);g.attr("disabled",null).text(b)};KDC.getTGTSession(d.client,a).then(function(a){h();c.fadeOut(function(){$(this).remove()});e.resolve(a)},function(a){a=a instanceof kcrypto.DecryptionError?"Incorrect password!":a instanceof KDC.Error?a.code==krb.KDC_ERR_C_PRINCIPAL_UNKNOWN?"User does not exist!":a.code==krb.KDC_ERR_PREAUTH_FAILED||a.code==krb.KRB_AP_ERR_BAD_INTEGRITY?
"Incorrect password!":a.message:a instanceof KDC.NetworkError?a.message:String(a);$("#alert-title").text("Error logging in:");$("#alert-text").text(a);$("#alert").slideDown(100);h()}).done()}else $(this).find(".password + .error").fadeIn()});return e.promise}
function getTGTSession(){"1"!==localStorage.getItem("version")&&(localStorage.clear(),localStorage.setItem("version","1"));var d=localStorage.getItem("tgtSession");return d?(d=krb.Session.fromDict(JSON.parse(d)),d.isExpired()?showRenewPrompt(d).then(function(d){localStorage.setItem("tgtSession",JSON.stringify(d.toDict()));return[d,!0]}):Q.resolve([d,!1])):showLoginPrompt().then(function(d){localStorage.setItem("tgtSession",JSON.stringify(d.toDict()));return[d,!0]})}
$(function(){function d(){getTGTSession().then(function(e){var c=e[0];e=e[1];log(c);var f=$("#authed-template").children().clone();f.appendTo(document.body);e&&f.fadeIn();f.find(".client-principal").text(c.client.toString());f.find("button.logout").click(function(){localStorage.removeItem("tgtSession");f.remove();d()})}).done()}$('<img src="eye-small.png">').css({left:78,top:12}).appendTo("#logo");$('<img src="eye-large.png">').css({left:87,top:16}).appendTo("#logo");$('<img src="eye-large.png">').css({left:105,
top:16}).appendTo("#logo");$('<img src="eye-small.png">').css({left:121,top:12}).appendTo("#logo");$(document).mousemove(function(d){$("#logo img").each(function(){var c=d.pageX-$(this).offset().left-$(this).width()/2,f=d.pageY-$(this).offset().top-$(this).height()/2,c="rotate("+Math.atan2(c,-f)+"rad)";$(this).css({transform:c})})});$("#whatis a").click(function(){$("#info").slideToggle(0).css("height",$("#info").height()).slideToggle(0).slideToggle();return!1});"#!request_ticket_v1"==location.hash?
registerTicketAPI():d()});
//@ sourceMappingURL=webathena-ui.js.map
